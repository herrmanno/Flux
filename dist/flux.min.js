var ho;!function(t){var n;!function(t){var n=function(){function t(){this.prefix="ID_",this.lastID=1,this.callbacks={}}return t.prototype.register=function(t,n){var r=this.prefix+this.lastID++;return this.callbacks[r]=n?t.bind(n):t,r},t.prototype.unregister=function(t){if(!this.callbacks[t])throw"Could not unregister callback for id "+t;delete this.callbacks[t]},t}();t.CallbackHolder=n}(n=t.flux||(t.flux={}))}(ho||(ho={}));var ho;!function(t){var n;!function(t){var n;!function(t){var n=function(){function t(){}return Object.defineProperty(t.prototype,"name",{get:function(){return this.constructor.toString().match(/\w+/g)[1]},enumerable:!0,configurable:!0}),t}();t.Action=n}(n=t.actions||(t.actions={}))}(n=t.flux||(t.flux={}))}(ho||(ho={}));var ho;!function(t){var n;!function(n){var r;!function(n){var r=t.promise.Promise;n.mapping={},n.useDir=!0;var e=function(){function e(){this.actions={},this.actionLoader=new t.classloader.ClassLoader({urlTemplate:"actions/${name}.js",useDir:n.useDir})}return e.prototype.register=function(t){return this.actions[t.name]=t,t},e.prototype.get=function(t){var n=void 0;return n="string"==typeof t?t:t.toString().match(/\w+/g)[1],this.actions[n]},e.prototype.loadAction=function(t){var e=this;return this.actions[t]?r.create(this.actions[t]):this.actionLoader.load({name:t,url:n.mapping[t],"super":["ho.flux.actions.Action"]}).then(function(t){return t.map(function(t){e.get(t)||e.register(new t)}),e.get(t.pop())})},e}();n.Registry=e}(r=n.actions||(n.actions={}))}(n=t.flux||(t.flux={}))}(ho||(ho={}));var ho;!function(t){var n;!function(n){var r;!function(n){var r=t.promise.Promise;n.mapping={},n.useDir=!0;var e=function(){function e(){this.stores={},this.storeLoader=new t.classloader.ClassLoader({urlTemplate:"stores/${name}.js",useDir:n.useDir})}return e.prototype.register=function(t){return this.stores[t.name]=t,t},e.prototype.get=function(t){var n=void 0;return n="string"==typeof t?t:t.toString().match(/\w+/g)[1],this.stores[n]},e.prototype.loadStore=function(t,e){void 0===e&&(e=!0);var i=this,o=[];return this.stores[t]?r.create(this.stores[t]):this.storeLoader.load({name:t,url:n.mapping[t],"super":["ho.flux.Store","ho.flux.Router"]}).then(function(t){o=t,t=t.filter(function(t){return!i.get(t)});var n=t.map(function(t){var n=i.register(new t);return e&&(n=n.init()),r.create(n)});return r.all(n)}).then(function(t){return i.get(o.pop())})},e}();n.Registry=e}(r=n.registry||(n.registry={}))}(n=t.flux||(t.flux={}))}(ho||(ho={}));var ho;!function(t){var n;!function(n){var r;!function(n){var r=t.promise.Promise,e=function(){function t(){this.useMin=!1}return t.prototype.resolve=function(){return this.useMin?"states.min.js":"states.js"},t.prototype.getStates=function(t){var n=this;return void 0===t&&(t="States"),new r(function(r,e){var i=n.resolve(),o=document.createElement("script");o.onload=function(){r(new window[t])},o.onerror=function(t){e(t)},o.src=i,document.getElementsByTagName("head")[0].appendChild(o)})},t}();n.instance=new e}(r=n.stateprovider||(n.stateprovider={}))}(n=t.flux||(t.flux={}))}(ho||(ho={}));var __extends=this&&this.__extends||function(t,n){function r(){this.constructor=t}for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e]);r.prototype=n.prototype,t.prototype=new r},ho;!function(t){var n;!function(n){var r=function(n){function r(){n.call(this),this.handlers={},this.actions=[],this.id=t.flux.DISPATCHER.register(this.handle.bind(this));var e=this,i=r.handlerMap[this.constructor.prototype];for(var o in i){var a=i[o];a.forEach(function(t){var n=e[t].bind(e);e.on(o,n)})}}return __extends(r,n),r.prototype.init=function(){return t.promise.Promise.all(this.actions.map(function(n){return t.flux.ACTIONS.loadAction(n)}))},Object.defineProperty(r.prototype,"name",{get:function(){return this.constructor.toString().match(/\w+/g)[1]},enumerable:!0,configurable:!0}),r.prototype.register=function(t,r){return n.prototype.register.call(this,t,r)},r.prototype.on=function(t,n){this.handlers[t]=n},r.prototype.handle=function(t){"function"==typeof this.handlers[t.type]&&this.handlers[t.type](t.data)},r.prototype.changed=function(){for(var t in this.callbacks){var n=this.callbacks[t];n&&n(this.data)}},r.handlerMap={},r.on=function(t){return function(n,e,i){return r.handlerMap[n]=r.handlerMap[n]||{},r.handlerMap[n][t]=r.handlerMap[n][t]||[],r.handlerMap[n][t].push(e),i}},r}(n.CallbackHolder);n.Store=r}(n=t.flux||(t.flux={}))}(ho||(ho={}));var __extends=this&&this.__extends||function(t,n){function r(){this.constructor=t}for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e]);r.prototype=n.prototype,t.prototype=new r},ho;!function(t){var n;!function(n){var r=t.promise.Promise,e=function(e){function i(){e.apply(this,arguments),this.mapping=null}return __extends(i,e),i.prototype.init=function(){this.on("STATE",this.onStateChangeRequested.bind(this));var t=this.onHashChange.bind(this);return this.initStates().then(function(){window.onhashchange=t,t()})},i.prototype.go=function(n,r){var e={state:void 0,args:void 0,extern:!1};"string"==typeof n?(e.state=n,e.args=r):(e.state=n.state,e.args=n.args),t.flux.DISPATCHER.dispatch({type:"STATE",data:e})},i.prototype.initStates=function(){return n.stateprovider.instance.getStates().then(function(t){this.mapping=t.states}.bind(this))},i.prototype.getStateFromName=function(t){return this.mapping.filter(function(n){return n.name===t})[0]},i.prototype.onStateChangeRequested=function(t){var n=this.getStateFromName(t.state),e=this.urlFromState(n.url,t.args);if(!(this.data&&this.data.state&&this.data.state.name===t.state&&this.equals(this.data.args,t.args)&&e===window.location.hash.substr(1))){n.redirect&&(n=this.getStateFromName(n.redirect));var i="function"==typeof n.before?n.before(t):r.create(void 0);i.then(function(){var r=!!t.extern;this.data={state:n,args:t.args,extern:r};var e=this.urlFromState(n.url,t.args);this.setUrl(e),this.changed()}.bind(this),function(t){this.onStateChangeRequested(t)}.bind(this))}},i.prototype.onHashChange=function(){var n=this.stateFromUrl(window.location.hash.substr(1));t.flux.DISPATCHER.dispatch({type:"STATE",data:{state:n.state,args:n.args,extern:!0}})},i.prototype.setUrl=function(t){if(window.location.hash.substr(1)!==t){var n=window.onhashchange;window.onhashchange=null,window.location.hash=t,window.onhashchange=n}},i.prototype.regexFromUrl=function(t){for(var n=/:([\w]+)/;t.match(n);)t=t.replace(n,"([^/]+)");return t+"$"},i.prototype.argsFromUrl=function(t,n){var r=this.regexFromUrl(t),e=t.match(r).slice(1),i=n.match(r).slice(1),o={};return e.forEach(function(t,n){o[t.substr(1)]=i[n]}),o},i.prototype.stateFromUrl=function(t){var n=this,r=void 0;if(this.mapping.forEach(function(e){if(!r){var i=n.regexFromUrl(e.url);if(t.match(i)){var o=n.argsFromUrl(e.url,t);r={state:e.name,args:o,extern:!1}}}}),!r)throw"No State found for url "+t;return r},i.prototype.urlFromState=function(t,n){for(var r=/:([\w]+)/;t.match(r);)t=t.replace(r,function(t){return n[t.substr(1)]});return t},i.prototype.equals=function(t,n){return JSON.stringify(t)===JSON.stringify(n)},i}(n.Store);n.Router=e}(n=t.flux||(t.flux={}))}(ho||(ho={}));var __extends=this&&this.__extends||function(t,n){function r(){this.constructor=t}for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e]);r.prototype=n.prototype,t.prototype=new r},ho;!function(t){var n;!function(t){var n=function(t){function n(){t.apply(this,arguments),this.isPending={},this.isHandled={},this.isDispatching=!1,this.pendingPayload=null}return __extends(n,t),n.prototype.waitFor=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];if(!this.isDispatching)throw"Dispatcher.waitFor(...): Must be invoked while dispatching.";for(var r=0;r<t.length;r++){var e=t[r];if(this.isPending[e]){if(!this.isHandled[e])throw"waitFor(...): Circular dependency detected while wating for "+e}else{if(!this.callbacks[e])throw"waitFor(...): "+e+" does not map to a registered callback.";this.invokeCallback(e)}}},n.prototype.dispatch=function(t){if(this.isDispatching)throw"Cannot dispatch in the middle of a dispatch.";this.startDispatching(t);try{for(var n in this.callbacks)this.isPending[n]||this.invokeCallback(n)}finally{this.stopDispatching()}},n.prototype.invokeCallback=function(t){this.isPending[t]=!0,this.callbacks[t](this.pendingPayload),this.isHandled[t]=!0},n.prototype.startDispatching=function(t){for(var n in this.callbacks)this.isPending[n]=!1,this.isHandled[n]=!1;this.pendingPayload=t,this.isDispatching=!0},n.prototype.stopDispatching=function(){this.pendingPayload=null,this.isDispatching=!1},n}(t.CallbackHolder);t.Dispatcher=n}(n=t.flux||(t.flux={}))}(ho||(ho={}));var ho;!function(t){var n;!function(n){function r(t){return void 0===t&&(t=n.Router),new e(function(r,e){n.STORES.get(t)?r(n.STORES.get(t)):t===n.Router?r(new n.Router):"function"==typeof t?r(new t):"string"==typeof t&&n.STORES.loadStore(t).then(function(t){return r(t)})}).then(function(t){return n.STORES.register(t).init()})}var e=t.promise.Promise;n.DISPATCHER=new n.Dispatcher,n.STORES=new n.registry.Registry,n.ACTIONS=new n.actions.Registry,n.dir=!1,n.run=r}(n=t.flux||(t.flux={}))}(ho||(ho={}));